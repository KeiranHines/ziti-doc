---
title: Controller Deployment
sidebar_label: Controller
id: deploy
---

import CliLogFormats from '../../../_cli-log-levels-and-formats.md'

This article is about deploying a Ziti Controller as a Linux system service. [The controller introduction](/learn/introduction/03-components.md#openziti-controller) introduces the architectural concepts used in this guide.

## Installation

The controller package is installed the same way as the `ziti` CLI and depends on the `openziti` package that provides the CLI.

```text
curl -sS https://get.openziti.io/install.bash \
| sudo bash -s openziti-controller
```

You must provide these two answers to start the service.

1. In `/opt/openziti/etc/controller/env` (the systemd env file for the controller service)
    1. Set `ZITI_CTRL_ADVERTISED_ADDRESS` to the FQDN of the controller
    1. Temporarily set `ZITI_PWD` to the desired management password for user `admin`. You may delete this password after bootstrapping for security.

### Bootstrapping the Public Key Infrastructure

The controller service will bootstrap a root and intermediate CA during the first startup.

The controller needs a CA to issue certificates for edge identities during enrollment. This CA is known as the edge signer. It's a good idea to use an intermediate CA for this purpose, as it allows you to rotate the edge signer without changing the root of trust and invalidating all edge enrollments.

Disable bootstrapping a PKI by setting `ZITI_BOOTSTRAP_PKI=false` in `/lib/systemd/system/ziti-controller.service`.

Check out [the PKI page](/learn/core-concepts/pki.md) for an overview of these concepts.

### Bootstrapping the Configuration

The controller service will bootstrap a configuration during the first startup.

The controller's configuration is loaded from a YAML file ([reference](/reference/30-configuration/controller.md)). The Linux system service will generate a valid configuration during the first startup, unless one already exists. 

The filename of the configuration file, relative to the Linux service's working directory (`/var/lib/ziti-controller`), is specified in `/lib/systemd/system/ziti-controller.service` as an argument to the `ExecStart` command.

Disable bootstrapping a configuration by setting `ZITI_BOOTSTRAP_CONFIG=false` in `/lib/systemd/system/ziti-controller.service`.

### Bootstrapping the Database

The controller service will bootstrap a database during the first startup.

The controller requires a BoltDB database to store its state. The Linux system service will initialize a database with a default admin password during the first startup, unless one already exists.

You must specify the management password for the default admin user before starting the service. This is done by setting `ZITI_PWD` in `/opt/openziti/etc/controller/env` or one of `LoadCredential` or `SetCredential` in `/lib/systemd/system/ziti-controller.service`. You may delete the password after bootstrapping for security.

Disable bootstrapping the database by setting `ZITI_BOOTSTRAP_DATABASE=false` in `/lib/systemd/system/ziti-controller.service`.

## Firewall

The controller listens on a single configurable TCP port: `1280/tcp`. This TLS server employs SNI to select the correct certificate for presentation when there are multiple certificates. Ziti clients use ALPN to negotiate a connection to the router control plane (`ziti-ctrl`) or the REST APIs (`h2`, `http/1.1`).

You may set `ZITI_CTRL_ADVERTISED_PORT` in `/opt/openziti/etc/controller/env` to bootstrap with a different port.

Clients "learn" the controller's address and port when they enroll, so it is necessary to re-enroll or re-create the client if the controller's address or port changes.

## Agent

The controller provides an IPC agent for administration. The agent listens on a Unix domain socket inside the filesystem namespace of the controller service. Here's an example for querying the controller's agent for statistics.

```text
systemctl show -p MainPID --value ziti-controller.service \
| xargs -rIPID sudo nsenter --target PID --mount -- \
    ziti agent stats
```

```buttonless title="Output"
goroutines: 50
OS threads: 22
GOMAXPROCS: 16
num CPU: 16
```

## Logging

<CliLogFormats/>